<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">

    <title>Meeting details</title>
    <script th:replace="insert/fragment :: headerElement"></script>
</head>
<body>
<script th:replace="insert/fragment :: navbar"></script>
<div th:if="${error != null}" style="text-align: center">
    <span th:text="${error}" style="background-color: lightpink; "></span>
</div>
<div class="container">
    <div class="row" sec:authorize="!isAuthenticated()">
        <a href="/">Back</a>
    </div>
    <div class="row" sec:authorize="isAuthenticated()">
        <a href="/user/back">Back</a>
    </div>

    <!--    GAME DETAILS-->
    <div class="row">
        <h1 th:text="${meet.getGame().getTitle()}"></h1>

    </div>
    <div class="row justify-content-left">
        <table cellpadding="20px">
            <tr>
                <td>
                    <div><img th:src="${meet.getCity().getLogo()}" height="100px"></div>
                    <div><span>Location: <span th:text="${meet.getLocation()}"></span></span></div>
                    <div><span>Date: <span
                            th:text="${#temporals.format(meet.getDateTime(), 'dd-MM-yyyy')}"></span></span></div>
                    <div><span>Time: <span th:text="${#temporals.format(meet.getDateTime(), 'HH:mm')}"></span></span>
                    </div>
                    <div><span>Creator: <span th:text="${meet.getCreator().getLogin()}"></span></span></div>
                    <div th:if="${meet.getCreator() == user}">


                        <a th:if="${meet.getState().name() != 'Activated'}"
                           th:href="@{/user/delete_meet(meetId = ${meet.getId()})}">Delete meeting</a>

                        <a th:if="${meet.getState().name() == 'Activated'}"
                           th:href="@{/user/close_meet(meetId = ${meet.getId()})}">Close meeting</a>

                        <br>

                        <a th:if="${meet.getState().name() == 'Started'}"
                           th:href="@{/user/activate_meet(meetId = ${meet.getId()})}">Activate meeting</a>
                    </div>

                    <div th:if="${!(meet.getCreator() == user) and meet.getState().name() != 'Activated'}">
                        <a th:href="@{/user/leave_meet(meetId = ${meet.getId()})}">Leave meeting</a>
                    </div>

                </td>
                <td>
                    <form th:action="@{/user/rate_meeting}" method="post" th:object="${ratingDTO.getResults()}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="meetId" th:value="${meet.getId()}"/>
                        <fieldset>
                            <table class="table" id="users">
                                <thead>
                                <tr>
                                    <th class="btn-light" onclick="sortTable(0, 'users')"><a href="#">Login</a></th>
                                    <th class="btn-light" onclick="sortTable(1, 'users')"><a href="#">City</a></th>
                                    <th class="btn-light" onclick="sortTable(1, 'users')"><a href="#">Address</a></th>
                                    <th class="btn-light" onclick="sortTable(2, 'users')"><a href="#">Date of birth</a>
                                    </th>
                                    <th class="btn-light" onclick="sortTable(3, 'users')"><a href="#">Game
                                        experience</a></th>
                                    <th class="btn-light" onclick="sortTable(3, 'users')"><a href="#">Common
                                        experience</a></th>

                                </tr>
                                </thead>
                                <tbody>
                                <th:block th:each="usr, itemStat : ${meet.getMembers()}">
                                    <tr>
                                        <td th:text="${usr.getLogin()}" height="16px"></td>
                                        <td th:text="${usr.getCity().getName()}" align="right"></td>
                                        <td th:text="${usr.getAddress()}" align="right"></td>
                                        <td th:text="${usr.getDateOfBirth()}" align="right"></td>
                                        <td th:text="${usr.getExperienceInGame(meet.getGame())}" align="right"></td>
                                        <td th:text="${usr.getCommonExperience()}" align="right"></td>

                                        <td th:if="${meet.getCreator() == user and user != usr and meet.getState().name() != 'Activated'}">
                                            <a th:href="@{/user/delete_user_from_meet(userId = ${usr.getId()}, meetId = ${meet.getId()})}">Delete
                                                from meeting</a>
                                        </td>
                                        <td th:if="${meet.getCreator() == user and user == usr and meet.getState().name() != 'Activated'}">
                                            Creator
                                        </td>

                                        <td th:if="${meet.getState().name() == 'Activated' and !voicedUsers.contains(user)}">
                                            <input hidden th:name="|results[${itemStat.index}].userIdTo|"
                                                   th:value="${usr.getId()}"/>
                                            <input type="number" min="0" th:max="${meet.getNumberOfMembers()}"
                                                   class="form-control"
                                                   th:name="|results[${itemStat.index}].rate|"/>
                                        </td>
                                        <td th:if="${voicedUsers.contains(usr)}">Voiced!</td>
                                    </tr>
                                </th:block>
                                </tbody>
                            </table>
                        </fieldset>
                        <input th:if="${meet.getState().name() == 'Activated' and !voicedUsers.contains(user)}"
                               class="btn btn-lg btn-primary " type="submit" value="Rate members">
                    </form>
                </td>
            </tr>

        </table>


    </div>


</div>


</body>
</html>